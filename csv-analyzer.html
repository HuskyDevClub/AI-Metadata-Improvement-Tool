<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Open Data Demo - CSV Analyzer with Azure AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-size: 14px;
            font-weight: 500;
            color: #555;
            margin-bottom: 5px;
        }

        .input-group input,
        .input-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .file-input-wrapper input[type="file"] {
            flex: 1;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .status {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .status.success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }

        .status.warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #f57c00;
        }

        .results {
            display: none;
        }

        .results.show {
            display: block;
        }

        .description-box {
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .description-box h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .description-box p {
            color: #555;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .columns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .column-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
        }

        .column-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .column-card h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .column-type {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .type-categorical {
            background: #e3f2fd;
            color: #1976d2;
        }

        .type-numeric {
            background: #e8f5e9;
            color: #388e3c;
        }

        .type-text {
            background: #fff3e0;
            color: #f57c00;
        }

        .column-stats {
            font-size: 12px;
            color: #777;
            margin-bottom: 10px;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .column-description {
            color: #555;
            line-height: 1.5;
            font-size: 14px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .progress-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        .help-text {
            font-size: 13px;
            color: #777;
            margin-top: 5px;
            font-style: italic;
        }

        .how-it-works {
            background: #f0f7ff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .how-it-works h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .how-it-works ol {
            margin-left: 20px;
            line-height: 1.8;
            color: #555;
        }

        .how-it-works ol li {
            margin-bottom: 8px;
        }

        .prompt-editor {
            margin-top: 15px;
            padding: 15px;
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .prompt-editor h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 600;
        }

        .prompt-editor textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
        }

        .prompt-editor textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .editable-description {
            position: relative;
        }

        .edit-icon {
            cursor: pointer;
            color: #667eea;
            font-size: 18px;
            margin-left: 10px;
            transition: color 0.3s;
        }

        .edit-icon:hover {
            color: #764ba2;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .export-section {
            margin-top: 20px;
            padding: 15px;
            background: #f0f7ff;
            border-radius: 8px;
            text-align: center;
        }

        .export-section h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .btn-export {
            background: #28a745;
            color: white;
            margin: 0 5px;
        }

        .btn-export:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .regenerate-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            align-items: center;
        }

        .regenerate-controls .label {
            font-size: 13px;
            color: #666;
            font-weight: 600;
            margin-right: 5px;
        }

        .btn-regenerate {
            background: #667eea;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-regenerate:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-regenerate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-regenerate.concise {
            background: #17a2b8;
        }

        .btn-regenerate.concise:hover {
            background: #138496;
        }

        .btn-regenerate.detailed {
            background: #28a745;
        }

        .btn-regenerate.detailed:hover {
            background: #218838;
        }

        .custom-instruction-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
            flex: 1;
            min-width: 250px;
        }

        .custom-instruction-input {
            flex: 1;
            padding: 6px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 12px;
        }

        .custom-instruction-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .regenerating {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            font-size: 13px;
            font-weight: 600;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .toggle-section {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-section::before {
            content: '‚ñº';
            font-size: 12px;
            transition: transform 0.3s;
        }

        .toggle-section.collapsed::before {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        @media (max-width: 768px) {
            .config-grid,
            .columns-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üìä CSV Analyzer with Azure AI</h1>
        <p>Upload a CSV file or provide a URL, and let Azure AI generate intelligent descriptions</p>
        <p style="margin-top: 10px; font-size: 14px; opacity: 0.95;">
            Developed by <strong>The Four Musketeers</strong>: Danny Yue, Wynter Lin, Felix Zhao, Julia Zhu
        </p>
    </div>

    <div class="content">
        <!-- How It Works -->
        <div class="section">
            <div class="how-it-works">
                <h3>üîç How It Works</h3>
                <ol>
                    <li><strong>Upload Your Data:</strong> Choose a CSV file from your computer or provide a URL to a
                        hosted CSV file.
                    </li>
                    <li><strong>Automatic Analysis:</strong> The tool analyzes each column to determine its type
                        (numeric, categorical, or text) and calculates relevant statistics.
                    </li>
                    <li><strong>AI-Powered Descriptions:</strong> Azure OpenAI generates intelligent descriptions:
                        <ul style="margin-top: 5px;">
                            <li>A comprehensive <strong>dataset overview</strong> based on filename, column names, and
                                statistics
                            </li>
                            <li>Individual <strong>column descriptions</strong> that explain what each field represents
                                and its role in the dataset
                            </li>
                        </ul>
                    </li>
                    <li><strong>Customize Everything:</strong> Edit prompts before generation, modify descriptions after
                        they're created, or regenerate any description with one click using the üîÑ icon.
                    </li>
                    <li><strong>Export Results:</strong> Download all descriptions as JSON for documentation or further
                        processing.
                    </li>
                </ol>
            </div>
        </div>

        <!-- Azure AI Configuration -->
        <div class="section">
            <div class="section-title">‚öôÔ∏è Azure OpenAI Configuration</div>
            <div class="config-grid">
                <div class="input-group">
                    <label for="azureEndpoint">Azure OpenAI Endpoint *</label>
                    <input id="azureEndpoint" placeholder="https://your-resource.openai.azure.com" type="text"
                           value="https://ydlin-2486-resource.cognitiveservices.azure.com">
                    <span class="help-text">Your Azure OpenAI resource endpoint</span>
                </div>
                <div class="input-group">
                    <label for="azureKey">API Key *</label>
                    <input id="azureKey" placeholder="Your Azure OpenAI API key" type="password"
                           value="5N52Xsd8NJN0gR8l8Iek7ZgEyBLTgBRqABBFHPsbP8s8riHMgPtkJQQJ99BGACHYHv6XJ3w3AAAAACOGm3YD">
                    <span class="help-text">Found in Azure Portal under Keys and Endpoint</span>
                </div>
                <div class="input-group">
                    <label for="azureDeployment">Deployment Name *</label>
                    <input id="azureDeployment" placeholder="get-5-nano" type="text" value="gpt-5-nano">
                    <span class="help-text">Your model deployment name (e.g., gpt-4, gpt-35-turbo)</span>
                </div>
            </div>
        </div>

        <!-- Prompt Customization -->
        <div class="section">
            <div class="section-title toggle-section" onclick="toggleSection('promptSection')">
                ‚úèÔ∏è Customize AI Prompts (Optional)
            </div>
            <div class="collapsible-content collapsed" id="promptSection">
                <div class="prompt-editor">
                    <h4>üìã Dataset Description Prompt Template</h4>
                    <textarea id="datasetPromptTemplate">Generate a concise 2-3 sentence description of this dataset:

File Name: {fileName}
Number of Rows: {rowCount}
Columns:
{columnInfo}

Provide a brief overview of what this dataset contains and its potential use cases.</textarea>
                </div>

                <div class="prompt-editor">
                    <h4>üìä Column Description Prompt Template</h4>
                    <textarea id="columnPromptTemplate">Given this dataset context:
{datasetDescription}

Generate a concise 1-2 sentence description for the column "{columnName}".

Column statistics:
{columnStats}

Describe what this column represents and its role in the dataset.</textarea>
                </div>
                <p class="help-text" style="margin-top: 10px;">
                    Use placeholders: {fileName}, {rowCount}, {columnInfo}, {datasetDescription}, {columnName},
                    {columnStats}
                </p>
            </div>
        </div>

        <!-- CSV Input -->
        <div class="section">
            <div class="section-title">üìÅ CSV Data Source</div>
            <div class="input-group">
                <label>Choose Input Method</label>
                <select id="inputMethod" onchange="toggleInputMethod()">
                    <option value="file">Upload Local File</option>
                    <option value="url">Load from URL</option>
                </select>
            </div>

            <div class="input-group" id="fileInputSection" style="margin-top: 15px;">
                <label for="csvFile">Select CSV File *</label>
                <div class="file-input-wrapper">
                    <input accept=".csv" id="csvFile" type="file">
                </div>
            </div>

            <div class="input-group" id="urlInputSection" style="margin-top: 15px; display: none;">
                <label for="csvUrl">CSV URL *</label>
                <input id="csvUrl" placeholder="https://example.com/data.csv" type="text">
                <span class="help-text">Direct link to a CSV file</span>
            </div>

            <button class="btn btn-primary" onclick="analyzeCSV()" style="margin-top: 20px;">
                üöÄ Analyze CSV
            </button>
        </div>

        <!-- Status Messages -->
        <div class="status" id="statusMessage"></div>

        <!-- Results -->
        <div class="results" id="results">
            <div class="section">
                <div class="section-title">üìã Dataset Description</div>
                <div class="description-box" id="datasetDescription"></div>
            </div>

            <div class="section">
                <div class="section-title">üìä Column Descriptions</div>
                <div class="progress-info" id="progressInfo"></div>
                <div class="columns-grid" id="columnDescriptions"></div>
            </div>

            <div class="export-section" id="exportSection" style="display: none;">
                <h4>üíæ Export Results</h4>
                <button class="btn btn-export" onclick="exportToJSON()">
                    üì• Download as JSON
                </button>
            </div>
        </div>
    </div>
</div>

<script>
  let csvData = null;
  let fileName = '';
  let columnStats = {};
  let generatedResults = {
    datasetDescription: '',
    columnDescriptions: {}
  };

  function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    const toggle = section.previousElementSibling;
    section.classList.toggle('collapsed');
    toggle.classList.toggle('collapsed');
  }

  function toggleInputMethod() {
    const method = document.getElementById('inputMethod').value;
    const fileSection = document.getElementById('fileInputSection');
    const urlSection = document.getElementById('urlInputSection');

    if (method === 'file') {
      fileSection.style.display = 'block';
      urlSection.style.display = 'none';
    } else {
      fileSection.style.display = 'none';
      urlSection.style.display = 'block';
    }
  }

  function showStatus(message, type = 'info') {
    const statusEl = document.getElementById('statusMessage');
    statusEl.textContent = message;
    statusEl.className = `status ${type} show`;
  }

  function hideStatus() {
    const statusEl = document.getElementById('statusMessage');
    statusEl.className = 'status';
  }

  function validateConfig() {
    const endpoint = document.getElementById('azureEndpoint').value.trim();
    const key = document.getElementById('azureKey').value.trim();
    const deployment = document.getElementById('azureDeployment').value.trim();

    if (!endpoint || !key || !deployment) {
      showStatus('Please fill in all Azure OpenAI configuration fields', 'error');
      return false;
    }

    return {endpoint, key, deployment};
  }

  async function callAzureOpenAI(prompt, config) {
    const url = `${config.endpoint.replace(/\/$/, '')}/openai/deployments/${config.deployment}/chat/completions?api-version=2025-01-01-preview`;

    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${config.key}`
      },
      body: JSON.stringify({
        messages: [
          {
            role: 'system',
            content: 'You are a data analyst expert who creates clear, concise, and informative descriptions of datasets and their columns.'
          },
          {
            role: 'user',
            content: prompt
          }
        ]
      })
    });

    if (!response.ok) {
      const error = await response.text();
      throw new Error(`Azure OpenAI API error: ${response.status} - ${error}`);
    }

    const data = await response.json();
    return data.choices[0].message.content;
  }

  function analyzeColumn(columnName, values) {
    // Determine column type and calculate statistics
    const nonNullValues = values.filter(v => v !== null && v !== undefined && v !== '');

    if (nonNullValues.length === 0) {
      return {type: 'empty', stats: {}};
    }

    // Try to parse as numbers
    const numericValues = nonNullValues.map(v => parseFloat(v)).filter(v => !isNaN(v));

    if (numericValues.length / nonNullValues.length > 0.8) {
      // Numeric column
      numericValues.sort((a, b) => a - b);
      return {
        type: 'numeric',
        stats: {
          count: numericValues.length,
          min: Math.min(...numericValues),
          max: Math.max(...numericValues),
          mean: numericValues.reduce((a, b) => a + b, 0) / numericValues.length,
          q1: numericValues[Math.floor(numericValues.length * 0.25)],
          median: numericValues[Math.floor(numericValues.length * 0.5)],
          q3: numericValues[Math.floor(numericValues.length * 0.75)]
        }
      };
    }

    // Check if categorical
    const uniqueValues = [...new Set(nonNullValues)];
    const uniqueRatio = uniqueValues.length / nonNullValues.length;

    if (uniqueRatio < 0.5 || uniqueValues.length < 50) {
      // Categorical column
      return {
        type: 'categorical',
        stats: {
          count: nonNullValues.length,
          uniqueCount: uniqueValues.length,
          values: uniqueValues.slice(0, 20), // First 20 unique values
          hasMore: uniqueValues.length > 20
        }
      };
    }

    // Text column
    return {
      type: 'text',
      stats: {
        count: nonNullValues.length,
        uniqueCount: uniqueValues.length,
        samples: nonNullValues.slice(0, 5) // First 5 samples
      }
    };
  }

  function makeEditable(elementId, columnName = null) {
    const element = document.getElementById(elementId);
    const currentText = element.querySelector('p').textContent;

    const textarea = document.createElement('textarea');
    textarea.className = 'description-textarea';
    textarea.value = currentText;

    const actions = document.createElement('div');
    actions.className = 'edit-actions';
    actions.innerHTML = `
                <button class="btn btn-primary btn-small" onclick="saveEdit('${elementId}', '${columnName}')">üíæ Save</button>
                <button class="btn btn-secondary btn-small" onclick="cancelEdit('${elementId}', '${columnName}')">‚ùå Cancel</button>
            `;

    const container = element.querySelector('.editable-description') || element;
    container.innerHTML = '';
    container.appendChild(textarea);
    container.appendChild(actions);
  }

  function saveEdit(elementId, columnName) {
    const element = document.getElementById(elementId);
    const textarea = element.querySelector('textarea');
    const newText = textarea.value;

    if (columnName && columnName !== 'null') {
      generatedResults.columnDescriptions[columnName] = newText;
    } else {
      generatedResults.datasetDescription = newText;
    }

    renderDescription(elementId, newText, columnName);
  }

  function cancelEdit(elementId, columnName) {
    const text = columnName && columnName !== 'null'
      ? generatedResults.columnDescriptions[columnName]
      : generatedResults.datasetDescription;
    renderDescription(elementId, text, columnName);
  }

  function renderDescription(elementId, text, columnName = null) {
    const element = document.getElementById(elementId);
    const container = element.querySelector('.editable-description') || element;

    const isDataset = !columnName || columnName === 'null';
    const controlsId = isDataset ? 'datasetControls' : `controls-${columnName.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const customInputId = isDataset ? 'customInputDataset' : `customInput-${columnName.replace(/[^a-zA-Z0-9]/g, '_')}`;

    container.innerHTML = `
                <p>${text}</p>
                <span class="edit-icon" onclick="makeEditable('${elementId}', '${columnName}')" title="Edit description">‚úèÔ∏è</span>
                <div class="regenerate-controls" id="${controlsId}">
                    <span class="label">Regenerate:</span>
                    <button class="btn-regenerate" onclick="regenerateDescription('${isDataset ? 'dataset' : 'column'}', '', '', ${isDataset ? 'null' : `'${columnName}'`})" title="Regenerate with same prompt">
                        üîÑ Again
                    </button>
                    <button class="btn-regenerate concise" onclick="regenerateDescription('${isDataset ? 'dataset' : 'column'}', 'concise', '', ${isDataset ? 'null' : `'${columnName}'`})" title="Make more concise">
                        ‚ö° More Concise
                    </button>
                    <button class="btn-regenerate detailed" onclick="regenerateDescription('${isDataset ? 'dataset' : 'column'}', 'detailed', '', ${isDataset ? 'null' : `'${columnName}'`})" title="Make more detailed">
                        üìù More Detailed
                    </button>
                    <div class="custom-instruction-wrapper">
                        <input type="text" id="${customInputId}" class="custom-instruction-input" placeholder="Custom instruction..." />
                        <button class="btn-regenerate" onclick="applyCustomInstruction('${isDataset ? 'dataset' : 'column'}', ${isDataset ? 'null' : `'${columnName}'`})" title="Apply custom instruction">
                            ‚ú® Apply
                        </button>
                    </div>
                </div>
            `;
  }

  async function regenerateDescription(target, modifier = '', customInstruction = '', columnName = null) {
    const config = validateConfig();
    if (!config) return;

    const elementId = columnName ? `colDesc-${columnName.replace(/[^a-zA-Z0-9]/g, '_')}` : 'datasetDescContent';
    const controlsId = columnName ? `controls-${columnName.replace(/[^a-zA-Z0-9]/g, '_')}` : 'datasetControls';

    // Show loading state
    const controlsElement = document.getElementById(controlsId);
    const originalContent = controlsElement.innerHTML;
    controlsElement.innerHTML = '<span class="regenerating"><span class="spinner"></span> Regenerating...</span>';

    // Disable all regenerate buttons
    document.querySelectorAll('.btn-regenerate').forEach(btn => btn.disabled = true);

    try {
      let newDescription;

      if (target === 'dataset') {
        newDescription = await regenerateDatasetDescription(config, modifier, customInstruction);
        generatedResults.datasetDescription = newDescription;
      } else {
        const info = columnStats[columnName];
        newDescription = await regenerateColumnDescription(columnName, info, config, modifier, customInstruction);
        generatedResults.columnDescriptions[columnName] = newDescription;
      }

      // Update the display
      renderDescription(elementId, newDescription, columnName);

      showStatus(`‚úÖ Successfully regenerated ${target === 'dataset' ? 'dataset' : 'column'} description!`, 'success');

    } catch (error) {
      controlsElement.innerHTML = originalContent;
      showStatus(`‚ùå Error regenerating: ${error.message}`, 'error');
      console.error('Regeneration error:', error);
    }

    // Re-enable all regenerate buttons
    document.querySelectorAll('.btn-regenerate').forEach(btn => btn.disabled = false);
  }

  async function regenerateDatasetDescription(config, modifier, customInstruction) {
    const columnInfo = Object.entries(columnStats).map(([col, info]) => {
      let desc = `- ${col} (${info.type})`;
      if (info.type === 'numeric') {
        desc += `: range [${info.stats.min.toFixed(2)} - ${info.stats.max.toFixed(2)}], avg: ${info.stats.mean.toFixed(2)}, median: ${info.stats.median.toFixed(2)}`;
      } else if (info.type === 'categorical') {
        desc += `: ${info.stats.uniqueCount} unique values [${info.stats.values.join(', ')}${info.stats.hasMore ? ', ...' : ''}]`;
      } else if (info.type === 'text') {
        desc += `: ${info.stats.uniqueCount} unique values, samples: ${info.stats.samples.slice(0, 2).join(', ')}...`;
      }
      return desc;
    }).join('\n');

    let promptTemplate = document.getElementById('datasetPromptTemplate').value;
    let prompt = promptTemplate
      .replace('{fileName}', fileName)
      .replace('{rowCount}', csvData.length)
      .replace('{columnInfo}', columnInfo);

    // Add modifiers
    if (modifier === 'concise') {
      prompt += '\n\nIMPORTANT: Make this description MORE CONCISE. Use fewer words while keeping key information.';
    } else if (modifier === 'detailed') {
      prompt += '\n\nIMPORTANT: Make this description MORE DETAILED. Provide additional context and insights.';
    }

    if (customInstruction) {
      prompt += `\n\nAdditional instruction: ${customInstruction}`;
    }

    return await callAzureOpenAI(prompt, config);
  }

  async function regenerateColumnDescription(columnName, columnInfo, config, modifier, customInstruction) {
    let statsText = '';
    if (columnInfo.type === 'numeric') {
      statsText = `This is a numeric column with values ranging from ${columnInfo.stats.min.toFixed(2)} to ${columnInfo.stats.max.toFixed(2)}. Average: ${columnInfo.stats.mean.toFixed(2)}, Median: ${columnInfo.stats.median.toFixed(2)}, Q1: ${columnInfo.stats.q1.toFixed(2)}, Q3: ${columnInfo.stats.q3.toFixed(2)}.`;
    } else if (columnInfo.type === 'categorical') {
      statsText = `This is a categorical column with ${columnInfo.stats.uniqueCount} unique values: ${columnInfo.stats.values.join(', ')}${columnInfo.stats.hasMore ? ', and more' : ''}.`;
    } else if (columnInfo.type === 'text') {
      statsText = `This is a text column with ${columnInfo.stats.uniqueCount} unique values. Sample values: ${columnInfo.stats.samples.slice(0, 3).join(', ')}.`;
    }

    let promptTemplate = document.getElementById('columnPromptTemplate').value;
    let prompt = promptTemplate
      .replace('{datasetDescription}', generatedResults.datasetDescription)
      .replace('{columnName}', columnName)
      .replace('{columnStats}', statsText);

    // Add modifiers
    if (modifier === 'concise') {
      prompt += '\n\nIMPORTANT: Make this description MORE CONCISE. Use fewer words while keeping key information.';
    } else if (modifier === 'detailed') {
      prompt += '\n\nIMPORTANT: Make this description MORE DETAILED. Provide additional context and insights.';
    }

    if (customInstruction) {
      prompt += `\n\nAdditional instruction: ${customInstruction}`;
    }

    return await callAzureOpenAI(prompt, config);
  }

  function applyCustomInstruction(target, columnName = null) {
    const inputId = columnName ? `customInput-${columnName.replace(/[^a-zA-Z0-9]/g, '_')}` : 'customInputDataset';
    const input = document.getElementById(inputId);
    const instruction = input.value.trim();

    if (!instruction) {
      showStatus('Please enter a custom instruction', 'warning');
      return;
    }

    regenerateDescription(target, '', instruction, columnName);
    input.value = ''; // Clear the input
  }

  async function generateDatasetDescription(config) {
    const columnInfo = Object.entries(columnStats).map(([col, info]) => {
      let desc = `- ${col} (${info.type})`;
      if (info.type === 'numeric') {
        desc += `: range [${info.stats.min.toFixed(2)} - ${info.stats.max.toFixed(2)}], avg: ${info.stats.mean.toFixed(2)}, median: ${info.stats.median.toFixed(2)}`;
      } else if (info.type === 'categorical') {
        desc += `: ${info.stats.uniqueCount} unique values [${info.stats.values.join(', ')}${info.stats.hasMore ? ', ...' : ''}]`;
      } else if (info.type === 'text') {
        desc += `: ${info.stats.uniqueCount} unique values, samples: ${info.stats.samples.slice(0, 2).join(', ')}...`;
      }
      return desc;
    }).join('\n');

    // Get custom prompt template
    let promptTemplate = document.getElementById('datasetPromptTemplate').value;
    const prompt = promptTemplate
      .replace('{fileName}', fileName)
      .replace('{rowCount}', csvData.length)
      .replace('{columnInfo}', columnInfo);

    return await callAzureOpenAI(prompt, config);
  }

  async function generateColumnDescription(columnName, columnInfo, datasetDesc, config) {
    let statsText = '';
    if (columnInfo.type === 'numeric') {
      statsText = `This is a numeric column with values ranging from ${columnInfo.stats.min.toFixed(2)} to ${columnInfo.stats.max.toFixed(2)}. Average: ${columnInfo.stats.mean.toFixed(2)}, Median: ${columnInfo.stats.median.toFixed(2)}, Q1: ${columnInfo.stats.q1.toFixed(2)}, Q3: ${columnInfo.stats.q3.toFixed(2)}.`;
    } else if (columnInfo.type === 'categorical') {
      statsText = `This is a categorical column with ${columnInfo.stats.uniqueCount} unique values: ${columnInfo.stats.values.join(', ')}${columnInfo.stats.hasMore ? ', and more' : ''}.`;
    } else if (columnInfo.type === 'text') {
      statsText = `This is a text column with ${columnInfo.stats.uniqueCount} unique values. Sample values: ${columnInfo.stats.samples.slice(0, 3).join(', ')}.`;
    }

    // Get custom prompt template
    let promptTemplate = document.getElementById('columnPromptTemplate').value;
    const prompt = promptTemplate
      .replace('{datasetDescription}', datasetDesc)
      .replace('{columnName}', columnName)
      .replace('{columnStats}', statsText);

    return await callAzureOpenAI(prompt, config);
  }

  async function processCSV() {
    const config = validateConfig();
    if (!config) return;

    // Show the results section immediately
    document.getElementById('results').classList.add('show');

    showStatus('Generating dataset description...', 'info');

    try {
      // Generate dataset description
      const datasetDesc = await generateDatasetDescription(config);
      generatedResults.datasetDescription = datasetDesc;

      const descEl = document.getElementById('datasetDescription');
      descEl.innerHTML = `
                    <h3>üìù Overview</h3>
                    <div id="datasetDescContent" class="editable-description">
                    </div>
                    <p style="margin-top: 10px; font-size: 13px; color: #777;">
                        <strong>File:</strong> ${fileName} |
                        <strong>Rows:</strong> ${csvData.length} |
                        <strong>Columns:</strong> ${Object.keys(columnStats).length}
                    </p>
                    <p style="margin-top: 10px; font-size: 12px; color: #999; font-style: italic;">
                        üí° Tip: Use ‚úèÔ∏è to edit or üîÑ to regenerate any description
                    </p>
                `;
      renderDescription('datasetDescContent', datasetDesc, null);

      // Generate column descriptions one by one
      const columns = Object.keys(columnStats);
      const columnsContainer = document.getElementById('columnDescriptions');
      columnsContainer.innerHTML = '';

      const progressEl = document.getElementById('progressInfo');

      for (let i = 0; i < columns.length; i++) {
        const col = columns[i];
        const info = columnStats[col];

        progressEl.textContent = `Generating descriptions... (${i + 1}/${columns.length})`;
        showStatus(`Generating description for column "${col}" (${i + 1}/${columns.length})`, 'info');

        // Create a placeholder card immediately
        const card = document.createElement('div');
        card.className = 'column-card';
        card.id = `column-${col.replace(/[^a-zA-Z0-9]/g, '_')}`;

        let typeClass = 'type-text';
        if (info.type === 'numeric') typeClass = 'type-numeric';
        else if (info.type === 'categorical') typeClass = 'type-categorical';

        let statsHtml = '';
        if (info.type === 'numeric') {
          statsHtml = `Min: ${info.stats.min.toFixed(2)} | Max: ${info.stats.max.toFixed(2)} | Avg: ${info.stats.mean.toFixed(2)} | Median: ${info.stats.median.toFixed(2)}`;
        } else if (info.type === 'categorical') {
          statsHtml = `${info.stats.uniqueCount} unique values | Top: ${info.stats.values.slice(0, 3).join(', ')}`;
        } else {
          statsHtml = `${info.stats.uniqueCount} unique values | ${info.stats.count} non-empty entries`;
        }

        card.innerHTML = `
                        <h4>
                            ${col}
                            <span class="column-type ${typeClass}">${info.type}</span>
                        </h4>
                        <div class="column-stats">${statsHtml}</div>
                        <div class="column-description" id="colDesc-${col.replace(/[^a-zA-Z0-9]/g, '_')}">
                            <div style="color: #999; font-style: italic;">‚è≥ Generating description...</div>
                        </div>
                    `;

        columnsContainer.appendChild(card);

        // Generate description
        const colDesc = await generateColumnDescription(col, info, datasetDesc, config);
        generatedResults.columnDescriptions[col] = colDesc;

        // Update the card with the description
        const descElement = document.getElementById(`colDesc-${col.replace(/[^a-zA-Z0-9]/g, '_')}`);
        descElement.innerHTML = '<div class="editable-description"></div>';
        renderDescription(`colDesc-${col.replace(/[^a-zA-Z0-9]/g, '_')}`, colDesc, col);
      }

      progressEl.textContent = '';
      showStatus('‚úÖ Analysis complete! All descriptions generated successfully.', 'success');

      // Show the export section
      document.getElementById('exportSection').style.display = 'block';

    } catch (error) {
      showStatus(`‚ùå Error: ${error.message}`, 'error');
      console.error('Error:', error);
    }
  }

  function exportToJSON() {
    const exportData = {
      metadata: {
        fileName: fileName,
        rowCount: csvData.length,
        columnCount: Object.keys(columnStats).length,
        exportDate: new Date().toISOString()
      },
      datasetDescription: generatedResults.datasetDescription,
      columns: Object.entries(columnStats).map(([name, info]) => ({
        name: name,
        type: info.type,
        statistics: info.stats,
        description: generatedResults.columnDescriptions[name] || ''
      }))
    };

    const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${fileName.replace('.csv', '')}_analysis.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showStatus('‚úÖ JSON file downloaded successfully!', 'success');
  }

  async function analyzeCSV() {
    const inputMethod = document.getElementById('inputMethod').value;

    hideStatus();
    document.getElementById('results').classList.remove('show');
    document.getElementById('exportSection').style.display = 'none';
    generatedResults = {datasetDescription: '', columnDescriptions: {}};

    try {
      if (inputMethod === 'file') {
        const fileInput = document.getElementById('csvFile');
        if (!fileInput.files[0]) {
          showStatus('Please select a CSV file', 'error');
          return;
        }
        fileName = fileInput.files[0].name;
        showStatus('Reading CSV file...', 'info');

        Papa.parse(fileInput.files[0], {
          header: true,
          skipEmptyLines: true,
          complete: function (results) {
            csvData = results.data;
            processData();
          },
          error: function (error) {
            showStatus(`Error parsing CSV: ${error.message}`, 'error');
          }
        });
      } else {
        const url = document.getElementById('csvUrl').value.trim();
        if (!url) {
          showStatus('Please enter a CSV URL', 'error');
          return;
        }
        fileName = url.split('/').pop() || 'remote-data.csv';
        showStatus('Fetching CSV from URL...', 'info');

        Papa.parse(url, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: function (results) {
            csvData = results.data;
            processData();
          },
          error: function (error) {
            showStatus(`Error fetching CSV: ${error.message}`, 'error');
          }
        });
      }
    } catch (error) {
      showStatus(`Error: ${error.message}`, 'error');
    }
  }

  function processData() {
    if (!csvData || csvData.length === 0) {
      showStatus('No data found in CSV file', 'error');
      return;
    }

    showStatus('Analyzing columns...', 'info');

    // Analyze each column
    columnStats = {};
    const columns = Object.keys(csvData[0]);

    columns.forEach(col => {
      const values = csvData.map(row => row[col]);
      columnStats[col] = analyzeColumn(col, values);
    });

    showStatus(`Analyzed ${columns.length} columns from ${csvData.length} rows`, 'success');

    // Start AI processing
    processCSV();
  }
</script>
</body>
</html>