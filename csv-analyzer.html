<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>CSV Analyzer with Azure AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-size: 14px;
            font-weight: 500;
            color: #555;
            margin-bottom: 5px;
        }

        .input-group input,
        .input-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .file-input-wrapper input[type="file"] {
            flex: 1;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .status {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .status.success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }

        .status.warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #f57c00;
        }

        .results {
            display: none;
        }

        .results.show {
            display: block;
        }

        .description-box {
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .description-box h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .description-box p {
            color: #555;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .columns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .column-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
        }

        .column-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .column-card h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .column-type {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .type-categorical {
            background: #e3f2fd;
            color: #1976d2;
        }

        .type-numeric {
            background: #e8f5e9;
            color: #388e3c;
        }

        .type-text {
            background: #fff3e0;
            color: #f57c00;
        }

        .column-stats {
            font-size: 12px;
            color: #777;
            margin-bottom: 10px;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .column-description {
            color: #555;
            line-height: 1.5;
            font-size: 14px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .progress-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        .help-text {
            font-size: 13px;
            color: #777;
            margin-top: 5px;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .config-grid,
            .columns-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üìä CSV Analyzer with Azure AI</h1>
        <p>Upload a CSV file or provide a URL, and let Azure AI generate intelligent descriptions</p>
    </div>

    <div class="content">
        <!-- Azure AI Configuration -->
        <div class="section">
            <div class="section-title">‚öôÔ∏è Azure OpenAI Configuration</div>
            <div class="config-grid">
                <div class="input-group">
                    <label for="azureEndpoint">Azure OpenAI Endpoint *</label>
                    <input , id="azureEndpoint" placeholder="https://your-resource.openai.azure.com/" type="text"
                           value="https://ydlin-2486-resource.cognitiveservices.azure.com/openai/deployments/gpt-5-nano/chat/completions?api-version=2025-01-01-preview">
                    <span class="help-text">Your Azure OpenAI resource endpoint</span>
                </div>
                <div class="input-group">
                    <label for="azureKey">API Key *</label>
                    <input , id="azureKey" placeholder="Your Azure OpenAI API key" type="password"
                           value="5N52Xsd8NJN0gR8l8Iek7ZgEyBLTgBRqABBFHPsbP8s8riHMgPtkJQQJ99BGACHYHv6XJ3w3AAAAACOGm3YD">
                    <span class="help-text">Found in Azure Portal under Keys and Endpoint</span>
                </div>
                <div class="input-group">
                    <label for="azureDeployment">Deployment Name *</label>
                    <input , id="azureDeployment" placeholder="get-5-nano" type="text" value="get-5-nano">
                    <span class="help-text">Your model deployment name (e.g., gpt-4, gpt-35-turbo)</span>
                </div>
            </div>
        </div>

        <!-- CSV Input -->
        <div class="section">
            <div class="section-title">üìÅ CSV Data Source</div>
            <div class="input-group">
                <label>Choose Input Method</label>
                <select id="inputMethod" onchange="toggleInputMethod()">
                    <option value="file">Upload Local File</option>
                    <option value="url">Load from URL</option>
                </select>
            </div>

            <div class="input-group" id="fileInputSection" style="margin-top: 15px;">
                <label for="csvFile">Select CSV File *</label>
                <div class="file-input-wrapper">
                    <input accept=".csv" id="csvFile" type="file">
                </div>
            </div>

            <div class="input-group" id="urlInputSection" style="margin-top: 15px; display: none;">
                <label for="csvUrl">CSV URL *</label>
                <input id="csvUrl" placeholder="https://example.com/data.csv" type="text">
                <span class="help-text">Direct link to a CSV file</span>
            </div>

            <button class="btn btn-primary" onclick="analyzeCSV()" style="margin-top: 20px;">
                üöÄ Analyze CSV
            </button>
        </div>

        <!-- Status Messages -->
        <div class="status" id="statusMessage"></div>

        <!-- Results -->
        <div class="results" id="results">
            <div class="section">
                <div class="section-title">üìã Dataset Description</div>
                <div class="description-box" id="datasetDescription"></div>
            </div>

            <div class="section">
                <div class="section-title">üìä Column Descriptions</div>
                <div class="progress-info" id="progressInfo"></div>
                <div class="columns-grid" id="columnDescriptions"></div>
            </div>
        </div>
    </div>
</div>

<script>
  let csvData = null;
  let fileName = '';
  let columnStats = {};

  function toggleInputMethod() {
    const method = document.getElementById('inputMethod').value;
    const fileSection = document.getElementById('fileInputSection');
    const urlSection = document.getElementById('urlInputSection');

    if (method === 'file') {
      fileSection.style.display = 'block';
      urlSection.style.display = 'none';
    } else {
      fileSection.style.display = 'none';
      urlSection.style.display = 'block';
    }
  }

  function showStatus(message, type = 'info') {
    const statusEl = document.getElementById('statusMessage');
    statusEl.textContent = message;
    statusEl.className = `status ${type} show`;
  }

  function hideStatus() {
    const statusEl = document.getElementById('statusMessage');
    statusEl.className = 'status';
  }

  function validateConfig() {
    const endpoint = document.getElementById('azureEndpoint').value.trim();
    const key = document.getElementById('azureKey').value.trim();
    const deployment = document.getElementById('azureDeployment').value.trim();

    if (!endpoint || !key || !deployment) {
      showStatus('Please fill in all Azure OpenAI configuration fields', 'error');
      return false;
    }

    return {endpoint, key, deployment};
  }

  async function callAzureOpenAI(prompt, config) {
    const url = `${config.endpoint}`;

    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${config.key}`,
        'api-key': config.key
      },
      body: JSON.stringify({
        messages: [
          {
            role: 'system',
            content: 'You are a data analyst expert who creates clear, concise, and informative descriptions of datasets and their columns.'
          },
          {
            role: 'user',
            content: prompt
          }
        ]
      })
    });

    if (!response.ok) {
      const error = await response.text();
      throw new Error(`Azure OpenAI API error: ${response.status} - ${error}`);
    }

    const data = await response.json();
    return data.choices[0].message.content;
  }

  function analyzeColumn(columnName, values) {
    // Determine column type and calculate statistics
    const nonNullValues = values.filter(v => v !== null && v !== undefined && v !== '');

    if (nonNullValues.length === 0) {
      return {type: 'empty', stats: {}};
    }

    // Try to parse as numbers
    const numericValues = nonNullValues.map(v => parseFloat(v)).filter(v => !isNaN(v));

    if (numericValues.length / nonNullValues.length > 0.8) {
      // Numeric column
      numericValues.sort((a, b) => a - b);
      return {
        type: 'numeric',
        stats: {
          count: numericValues.length,
          min: Math.min(...numericValues),
          max: Math.max(...numericValues),
          mean: numericValues.reduce((a, b) => a + b, 0) / numericValues.length,
          q1: numericValues[Math.floor(numericValues.length * 0.25)],
          median: numericValues[Math.floor(numericValues.length * 0.5)],
          q3: numericValues[Math.floor(numericValues.length * 0.75)]
        }
      };
    }

    // Check if categorical
    const uniqueValues = [...new Set(nonNullValues)];
    const uniqueRatio = uniqueValues.length / nonNullValues.length;

    if (uniqueRatio < 0.5 || uniqueValues.length < 50) {
      // Categorical column
      return {
        type: 'categorical',
        stats: {
          count: nonNullValues.length,
          uniqueCount: uniqueValues.length,
          values: uniqueValues.slice(0, 20), // First 20 unique values
          hasMore: uniqueValues.length > 20
        }
      };
    }

    // Text column
    return {
      type: 'text',
      stats: {
        count: nonNullValues.length,
        uniqueCount: uniqueValues.length,
        samples: nonNullValues.slice(0, 5) // First 5 samples
      }
    };
  }

  async function generateDatasetDescription(config) {
    const columnInfo = Object.entries(columnStats).map(([col, info]) => {
      let desc = `- ${col} (${info.type})`;
      if (info.type === 'numeric') {
        desc += `: range [${info.stats.min.toFixed(2)} - ${info.stats.max.toFixed(2)}], avg: ${info.stats.mean.toFixed(2)}, median: ${info.stats.median.toFixed(2)}`;
      } else if (info.type === 'categorical') {
        desc += `: ${info.stats.uniqueCount} unique values [${info.stats.values.join(', ')}${info.stats.hasMore ? ', ...' : ''}]`;
      } else if (info.type === 'text') {
        desc += `: ${info.stats.uniqueCount} unique values, samples: ${info.stats.samples.slice(0, 2).join(', ')}...`;
      }
      return desc;
    }).join('\n');

    const prompt = `Generate a concise 2-3 sentence description of this dataset:

File Name: ${fileName}
Number of Rows: ${csvData.length}
Columns:
${columnInfo}

Provide a brief overview of what this dataset contains and its potential use cases.`;

    return await callAzureOpenAI(prompt, config);
  }

  async function generateColumnDescription(columnName, columnInfo, datasetDesc, config) {
    let statsText = '';
    if (columnInfo.type === 'numeric') {
      statsText = `This is a numeric column with values ranging from ${columnInfo.stats.min.toFixed(2)} to ${columnInfo.stats.max.toFixed(2)}. Average: ${columnInfo.stats.mean.toFixed(2)}, Median: ${columnInfo.stats.median.toFixed(2)}, Q1: ${columnInfo.stats.q1.toFixed(2)}, Q3: ${columnInfo.stats.q3.toFixed(2)}.`;
    } else if (columnInfo.type === 'categorical') {
      statsText = `This is a categorical column with ${columnInfo.stats.uniqueCount} unique values: ${columnInfo.stats.values.join(', ')}${columnInfo.stats.hasMore ? ', and more' : ''}.`;
    } else if (columnInfo.type === 'text') {
      statsText = `This is a text column with ${columnInfo.stats.uniqueCount} unique values. Sample values: ${columnInfo.stats.samples.slice(0, 3).join(', ')}.`;
    }

    const prompt = `Given this dataset context:
${datasetDesc}

Generate a concise 1-2 sentence description for the column "${columnName}".

Column statistics:
${statsText}

Describe what this column represents and its role in the dataset.`;

    return await callAzureOpenAI(prompt, config);
  }

  async function processCSV() {
    const config = validateConfig();
    if (!config) return;

    showStatus('Generating dataset description...', 'info');

    try {
      // Generate dataset description
      const datasetDesc = await generateDatasetDescription(config);

      const descEl = document.getElementById('datasetDescription');
      descEl.innerHTML = `
                    <h3>üìù Overview</h3>
                    <p>${datasetDesc}</p>
                    <p style="margin-top: 10px; font-size: 13px; color: #777;">
                        <strong>File:</strong> ${fileName} | 
                        <strong>Rows:</strong> ${csvData.length} | 
                        <strong>Columns:</strong> ${Object.keys(columnStats).length}
                    </p>
                `;

      // Generate column descriptions
      const columns = Object.keys(columnStats);
      const columnsContainer = document.getElementById('columnDescriptions');
      columnsContainer.innerHTML = '';

      const progressEl = document.getElementById('progressInfo');

      for (let i = 0; i < columns.length; i++) {
        const col = columns[i];
        const info = columnStats[col];

        progressEl.textContent = `Generating descriptions... (${i + 1}/${columns.length})`;
        showStatus(`Generating description for column "${col}" (${i + 1}/${columns.length})`, 'info');

        const colDesc = await generateColumnDescription(col, info, datasetDesc, config);

        // Create column card
        const card = document.createElement('div');
        card.className = 'column-card';

        let typeClass = 'type-text';
        if (info.type === 'numeric') typeClass = 'type-numeric';
        else if (info.type === 'categorical') typeClass = 'type-categorical';

        let statsHtml = '';
        if (info.type === 'numeric') {
          statsHtml = `Min: ${info.stats.min.toFixed(2)} | Max: ${info.stats.max.toFixed(2)} | Avg: ${info.stats.mean.toFixed(2)} | Median: ${info.stats.median.toFixed(2)}`;
        } else if (info.type === 'categorical') {
          statsHtml = `${info.stats.uniqueCount} unique values | Top: ${info.stats.values.slice(0, 3).join(', ')}`;
        } else {
          statsHtml = `${info.stats.uniqueCount} unique values | ${info.stats.count} non-empty entries`;
        }

        card.innerHTML = `
                        <h4>
                            ${col}
                            <span class="column-type ${typeClass}">${info.type}</span>
                        </h4>
                        <div class="column-stats">${statsHtml}</div>
                        <div class="column-description">${colDesc}</div>
                    `;

        columnsContainer.appendChild(card);
      }

      progressEl.textContent = '';
      showStatus('‚úÖ Analysis complete! All descriptions generated successfully.', 'success');
      document.getElementById('results').classList.add('show');

    } catch (error) {
      showStatus(`‚ùå Error: ${error.message}`, 'error');
      console.error('Error:', error);
    }
  }

  async function analyzeCSV() {
    const inputMethod = document.getElementById('inputMethod').value;

    hideStatus();
    document.getElementById('results').classList.remove('show');

    try {
      if (inputMethod === 'file') {
        const fileInput = document.getElementById('csvFile');
        if (!fileInput.files[0]) {
          showStatus('Please select a CSV file', 'error');
          return;
        }
        fileName = fileInput.files[0].name;
        showStatus('Reading CSV file...', 'info');

        Papa.parse(fileInput.files[0], {
          header: true,
          skipEmptyLines: true,
          complete: function (results) {
            csvData = results.data;
            processData();
          },
          error: function (error) {
            showStatus(`Error parsing CSV: ${error.message}`, 'error');
          }
        });
      } else {
        const url = document.getElementById('csvUrl').value.trim();
        if (!url) {
          showStatus('Please enter a CSV URL', 'error');
          return;
        }
        fileName = url.split('/').pop() || 'remote-data.csv';
        showStatus('Fetching CSV from URL...', 'info');

        Papa.parse(url, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: function (results) {
            csvData = results.data;
            processData();
          },
          error: function (error) {
            showStatus(`Error fetching CSV: ${error.message}`, 'error');
          }
        });
      }
    } catch (error) {
      showStatus(`Error: ${error.message}`, 'error');
    }
  }

  function processData() {
    if (!csvData || csvData.length === 0) {
      showStatus('No data found in CSV file', 'error');
      return;
    }

    showStatus('Analyzing columns...', 'info');

    // Analyze each column
    columnStats = {};
    const columns = Object.keys(csvData[0]);

    columns.forEach(col => {
      const values = csvData.map(row => row[col]);
      columnStats[col] = analyzeColumn(col, values);
    });

    showStatus(`Analyzed ${columns.length} columns from ${csvData.length} rows`, 'success');

    // Start AI processing
    processCSV();
  }
</script>
</body>
</html>
